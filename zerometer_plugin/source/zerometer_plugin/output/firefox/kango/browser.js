function BrowserCookie(){this.name="",this.value="",this.domain="",this.hostOnly="",this.path="",this.secure=!1,this.httpOnly=!1,this.session=!1,this.expires=0}function BrowserBase(){EventTarget.call(this)}function BrowserTabsBase(){}function IBrowserWindow(){}function IBrowserTab(){}function getPublicApi(){return utils.createApiWrapper(module.exports,BrowserBase.prototype,IEventTarget.prototype)}var utils=require("kango/utils"),object=utils.object,array=utils.array,EventTarget=utils.EventTarget,IEventTarget=utils.IEventTarget,NotImplementedException=utils.NotImplementedException;BrowserBase.prototype=object.extend(EventTarget,{event:{DOCUMENT_COMPLETE:"DocumentComplete",BEFORE_NAVIGATE:"BeforeNavigate",TAB_CHANGED:"TabChanged",TAB_CREATED:"TabCreated",TAB_REMOVED:"TabRemoved",WINDOW_CHANGED:"WindowChanged"},getName:function(){throw new NotImplementedException},cookies:{getCookies:function(e,t){throw new NotImplementedException},getCookie:function(e,t,n){throw new NotImplementedException},setCookie:function(e,t){throw new NotImplementedException}},tabs:{},windows:{getAll:function(e){throw new NotImplementedException},getCurrent:function(e){throw new NotImplementedException},create:function(e){throw new NotImplementedException}}}),BrowserTabsBase.prototype={getAll:function(e){throw new NotImplementedException},getCurrent:function(e){throw new NotImplementedException},create:function(e){throw new NotImplementedException},broadcastMessage:function(e,t){this.getAll(function(n){array.forEach(n,function(n){n.dispatchMessage(e,t)})})}},IBrowserWindow.prototype={getId:function(){throw new NotImplementedException},getTabs:function(e){throw new NotImplementedException},getCurrentTab:function(e){throw new NotImplementedException},isActive:function(){throw new NotImplementedException}},IBrowserTab.prototype={getId:function(){throw new NotImplementedException},getUrl:function(){throw new NotImplementedException},getTitle:function(){throw new NotImplementedException},getDOMWindow:function(){throw new NotImplementedException},isActive:function(){throw new NotImplementedException},isPrivate:function(){throw new NotImplementedException},navigate:function(e){throw new NotImplementedException},activate:function(){throw new NotImplementedException},dispatchMessage:function(e,t){throw new NotImplementedException},close:function(){throw new NotImplementedException}};







function TabApiProxy(e){var n=require("kango/console"),t=require("kango/storage").storage,r=require("kango/i18n"),s=require("kango/invoke_async"),i=require("kango/message_target"),a=[];this.xhr={send:function(){var e=require("kango/xhr");return e.send.apply(e,arguments)}},this.console={log:function(){return n.log.apply(n,arguments)},warn:function(){return n.warn.apply(n,arguments)},error:function(){return n.error.apply(n,arguments)}},this.browser={getName:function(){return require("kango/browser").getName()}},this.io={getResourceUrl:function(e){return require("kango/io").getResourceUrl(e)}},this.tab={isPrivate:function(){return e.isPrivate()}},this.storage={setItem:function(e,n){return t.setItem(e,n)},getItem:function(e){return t.getItem(e)},removeItem:function(e){return t.removeItem(e)},getKeys:function(){return t.getKeys()},clear:function(){return t.clear()}},this.i18n={getMessage:function(){return r.getMessage.apply(r,arguments)},getMessages:function(){return r.getMessages.apply(r,arguments)},getCurrentLocale:function(){return r.getCurrentLocale.apply(r,arguments)}},this.getExtensionInfo=function(){return require("kango/extension_info").getRawData()};var u=this.dispatchMessage=function(n,t){var r=require("kango/messaging"),s={name:n,data:null!=t?object.sanitize(t):t,origin:"tab",source:e,target:e};return r.dispatchMessageEx(s)},o=this.addEventListener=function(e,n){if("message"==e){for(var t=0;t<a.length;t++)if(a[t]==n)return;a.push(n)}};this.fireEvent=function(e,n){if("message"==e){n.source&&n.target||(n.source=n.target=this);for(var t=0;t<a.length;t++)a[t](n)}};var g=new s(o,u,utils.func.invoke,func.bind(n.log,n));this.invokeAsync=g.invokeAsync,this.invokeAsyncCallback=g.invokeAsyncCallback;var c=new i(o);this.addMessageListener=func.bind(c.addMessageListener,c),this.removeMessageListener=func.bind(c.removeMessageListener,c)}var utils=require("kango/utils"),object=utils.object,func=utils.func;







function ExposedTabProxy(e,t){function n(e){return e&&object.isObject(e)?r.exposeObject(e,"r",t):e}TabApiProxy.call(this,e);var r=require("kango/lang"),o=require("kango/xhr"),i=require("kango/storage").storage,s=require("kango/i18n");this.getExtensionInfo=function(){return n(require("kango/extension_info").getRawData())},this.storage.getItem=function(e){return n(i.getItem(e))},this.storage.getKeys=function(){return n(i.getKeys())},this.i18n.getMessages=function(){return n(s.getMessages.apply(s,arguments))},this.xhr.send=function(e,n){e.sanitizeData=!0,o.send(e,function(e){e&&(e=r.exposeObject(e,"rw",t)),n(e)})};var a=null;return this.fireEvent=func.decorate(this.fireEvent,function(e,t){var r=t[0],o=t[1];o.source=o.target=null,o=n(o),o.source=o.target=a,e.call(this,r,o)}),a=r.exposeObject(this,"r",t),Services.vc.compare(Services.appinfo.platformVersion,"34")>=0&&(Cu.exportFunction(func.bind(this.xhr.send,a.xhr),a.xhr,{defineAs:"send",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.invokeAsyncCallback,a),a,{defineAs:"invokeAsyncCallback",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.invokeAsync,a),a,{defineAs:"invokeAsync",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.addMessageListener,a),a,{defineAs:"addMessageListener",allowCallbacks:!0}),Cu.exportFunction(func.bind(this.removeMessageListener,a),a,{defineAs:"removeMessageListener",allowCallbacks:!0})),this.wrappedObject=a,this}function WebProgressListener(e){this._callback=e}function BrowserTabs(){}function Browser(){BrowserBase.call(this),this.tabs=new BrowserTabs,this._tabs={},this._documentLoadListener=null,this.init()}function BrowserWindow(e){this._gBrowser=e.gBrowser,this._window=e}function BrowserTab(e,t){this._tabElem=e,this._id=t,this._proxies=[]}var utils=require("kango/utils"),func=utils.func,array=utils.array,object=utils.object,chromeWindows=require("kango/chrome_windows"),io=require("kango/io");WebProgressListener.prototype={QueryInterface:function(e){if(e.equals(Ci.nsIWebProgressListener)||e.equals(Ci.nsISupportsWeakReference)||e.equals(Ci.nsISupports))return this;throw Cr.NS_NOINTERFACE},onProgressChange:function(){},onStatusChange:function(){},onSecurityChange:function(){},onLocationChange:function(){},onStateChange:function(e,t,n,r){var o=Ci.nsIWebProgressListener;if(n&o.STATE_START&&n&o.STATE_IS_DOCUMENT){var i=Ci.nsIChannel,s={url:t.QueryInterface(i).originalURI.spec,window:e.DOMWindow};this._callback(s)}}},BrowserTabs.prototype=object.extend(BrowserTabsBase,{getAll:function(e){for(var t=[],n=browser.getBrowsers(),r=0;r<n.length;r++)t=t.concat(browser.getTabs(n[r]));e(t)},getCurrent:function(e){browser.windows.getCurrent(function(t){t.getCurrentTab(function(t){e(t)})})},create:function(e){var t="undefined"==typeof e.focused||e.focused,n="undefined"!=typeof e.reuse&&e.reuse,r=chromeWindows.getMostRecentChromeWindow().gBrowser,o=null;if(n)for(var i=0;i<r.browsers.length;i++){var s=r.getBrowserAtIndex(i);if(s.currentURI.spec==e.url){o=r.tabContainer.childNodes[i];break}}null==o&&(o=r.addTab(e.url)),t&&(r.selectedTab=o)}}),Browser.prototype=object.extend(BrowserBase,{init:function(){array.forEach(chromeWindows.getLoadedChromeWindows(),function(e){this._listenChromeWindowEvents(e)},this),chromeWindows.addEventListener(chromeWindows.event.WINDOW_LOAD,func.bind(function(e){this._listenChromeWindowEvents(e.window)},this)),this._addDocumentObserver()},dispose:function(){this._removeDocumentObserver(),this.removeAllEventListeners(),this._tabs={}},_addDocumentObserver:function(){var e=this._documentLoadListener=func.bind(this._onPageLoad,this),t=this;this._observer={observe:function(n,r,o){if("document-element-inserted"==r){var i=n;if(i&&i.defaultView){var s=i.defaultView;s&&t._isScriptableUrl(s.document.URL)&&(s.addEventListener("DOMContentLoaded",e,!0),s.addEventListener("load",e,!0),t.fireEvent("DocumentInserted",{window:s}))}}}},Services.obs.addObserver(t._observer,"document-element-inserted",!1)},_removeDocumentObserver:function(){Services.obs.removeObserver(this._observer,"document-element-inserted")},_isScriptableUrl:function(e){return 0==e.indexOf("http")||0==e.indexOf("file")},_listenChromeWindowEvents:function(e){var t=new WebProgressListener(func.bind(this._onPageBeforeNavigate,this));e.gBrowser.addProgressListener(t),chromeWindows.registerContainerUnloader(function(){e.gBrowser.removeProgressListener(t)},e);var n=func.bind(function(e){var t=e.target;(0==t.URL.indexOf("about:blank")||0==t.URL.indexOf(io.getExtensionFileUrl("")))&&this._onPageLoad(e)},this);e.gBrowser.addEventListener("DOMContentLoaded",n,!0),chromeWindows.registerContainerUnloader(function(){e.gBrowser.removeEventListener("DOMContentLoaded",n,!0)},e);var r=func.bind(this._onTabSelect,this);e.gBrowser.tabContainer.addEventListener("TabSelect",r,!0),chromeWindows.registerContainerUnloader(function(){e.gBrowser.tabContainer.removeEventListener("TabSelect",r,!0)},e);var o=func.bind(this._onTabOpen,this);e.gBrowser.tabContainer.addEventListener("TabOpen",o,!0),chromeWindows.registerContainerUnloader(function(){e.gBrowser.tabContainer.removeEventListener("TabOpen",o,!0)},e);var i=func.bind(this._onTabClose,this);e.gBrowser.tabContainer.addEventListener("TabClose",i,!0),chromeWindows.registerContainerUnloader(function(){e.gBrowser.tabContainer.removeEventListener("TabClose",i,!0)},e);var s=func.bind(this._onWindowActivate,this);e.addEventListener("activate",s,!0),chromeWindows.registerContainerUnloader(function(){e.removeEventListener("activate",s,!0)},e)},_onPageBeforeNavigate:function(e){var t=e.window;if(!t.frameElement){var n=t.top||t;this.fireEvent(this.event.BEFORE_NAVIGATE,{url:e.url,target:this.getTab(this.getTabFromWindow(n))})}},_onPageLoad:function(e){var t=e.target,n=t.defaultView;if(n.removeEventListener("load",this._documentLoadListener,!0),n.removeEventListener("DOMContentLoaded",this._documentLoadListener,!0),t instanceof n.HTMLDocument){var r=this.getTab(this.getTabFromWindow(n));r.deleteTabProxy(n);var o={url:r.getUrl(),title:r.getTitle(),target:r};t.defaultView.frameElement||this.fireEvent(this.event.DOCUMENT_COMPLETE,o),o.window=n,this.fireEvent("DocumentLoaded",o)}},_getTabId:function(e){return e.linkedPanel.toString().split("panel").pop()},_removeTab:function(e){return delete this._tabs[e]},_onTabSelect:function(e){var t=this.getTab(e.target);this.fireEvent(this.event.TAB_CHANGED,{url:t.getUrl(),title:t.getTitle(),target:t,tabId:t.getId()})},_onTabOpen:function(e){var t=this.getTab(e.target);this.fireEvent(this.event.TAB_CREATED,{target:t,tabId:t.getId()})},_onTabClose:function(e){var t=this._getTabId(e.target);this._removeTab(t),this.fireEvent(this.event.TAB_REMOVED,{tabId:t})},_onWindowActivate:function(e){var t=new BrowserWindow(e.target);this.fireEvent(this.event.WINDOW_CHANGED,{target:t,windowId:t.getId()})},getTabFromWindow:function(e){for(var t=e.top||e,n=this.getBrowsers(),r=0;r<n.length;r++){var o=n[r],i=o.getBrowserIndexForDocument(t.document);if(-1!=i)return o.tabContainer.childNodes[i]}return null},getBrowsers:function(){return array.map(chromeWindows.getLoadedChromeWindows(),function(e){return e.gBrowser})},getTabs:function(e){return array.map(e.tabContainer.childNodes,function(e){return browser.getTab(e)})},getTab:function(e){var t=this._getTabId(e);if("undefined"==typeof this._tabs[t]){this._tabs[t]=new BrowserTab(e,t);var n=this._tabs[t].getChromeWindow();chromeWindows.registerContainerUnloader(func.bind(function(){this._removeTab(t)},this),n)}return this._tabs[t]},getSandboxForWindow:function(e,t){var n=this.getTab(this.getTabFromWindow(e));return n.getSandboxForWindow(e,t)},getName:function(){return"firefox"},cookies:{getCookies:function(e,t){var n=[],r=Cc["@mozilla.org/cookiemanager;1"].getService(Ci.nsICookieManager),o=Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService),i=o.newURI(e,null,null);if(null!=i)for(var s=i.host,a=i.path||"/",c=r.enumerator;c.hasMoreElements();){var u=c.getNext().QueryInterface(Ci.nsICookie2);s.indexOf(u.host)+u.host.length==s.length&&0==a.indexOf(u.path)&&n.push({name:u.name,value:u.value,domain:u.host,hostOnly:u.isDomain,path:u.path,secure:u.isSecure,httpOnly:u.isHttpOnly,session:u.isSession,expires:u.expires})}t(n)},getCookie:function(e,t,n){this.getCookies(e,function(e){for(var r=0;r<e.length;r++)e[r].name==t&&n(e[r]);n(null)})},setCookie:function(e,t){var n=t.name,r=t.value,o=t.expires||null,i=t.secure||!1,s=t.httpOnly||!1,a=(t.session||!1,Cc["@mozilla.org/cookiemanager;1"].getService(Ci.nsICookieManager2)),c=Cc["@mozilla.org/network/io-service;1"].getService(Ci.nsIIOService),u=c.newURI(e,null,null);if(null!=u){var d=u.host,h=u.path;a.add(d,h,n,r,i,s,i,o)}}},windows:{getAll:function(e){e(array.map(chromeWindows.getLoadedChromeWindows(),function(e){return new BrowserWindow(e)}))},getCurrent:function(e){e(new BrowserWindow(chromeWindows.getMostRecentChromeWindow()))},create:function(e){chromeWindows.getMostRecentChromeWindow().open(e.url)}}}),BrowserWindow.prototype={getTabs:function(e){e(browser.getTabs(this._gBrowser))},getCurrentTab:function(e){for(var t=this._gBrowser.tabContainer,n=null,r=0;r<t.childNodes.length&&(n=t.childNodes[r],!n.selected);r++);e(browser.getTab(n))},getId:function(){var e=this._window.QueryInterface(Ci.nsIInterfaceRequestor).getInterface(Ci.nsIDOMWindowUtils);return e.outerWindowID},isActive:function(){return chromeWindows.getActiveWindow()==this._window}},BrowserTab.prototype={_getBrowserForTab:function(e){return e.linkedBrowser},_getBrowser:function(){return this._getBrowserForTab(this._tabElem)},_isWindowPrivate:function(e){try{return e.QueryInterface(Ci.nsIInterfaceRequestor).getInterface(Ci.nsIWebNavigation).QueryInterface(Ci.nsILoadContext).usePrivateBrowsing}catch(t){}try{return!!e.docShell.QueryInterface(Ci.nsILoadContext).usePrivateBrowsing}catch(t){}return!1},getChromeWindow:function(){return this._getBrowser().ownerDocument.defaultView},deleteTabProxy:function(e,t){for(var n=0;n<this._proxies.length;n++)if(this._proxies[n].window==e&&this._proxies[n].namespace==t)return this._proxies.splice(n,1),!0;return!1},getSandboxForWindow:function(e,t){for(var n=0;n<this._proxies.length;n++)if(this._proxies[n].window==e&&this._proxies[n].namespace==t)return this._proxies[n].sandbox;var r=new Cu.Sandbox(e,{sandboxPrototype:e,wantXrays:!0}),o=new ExposedTabProxy(this,r);return r.kango=o.wrappedObject,this._proxies.push({window:e,proxy:o,sandbox:r,namespace:t}),chromeWindows.registerContainerUnloader(func.bind(function(){this.deleteTabProxy(e,t)},this),e),r},getId:function(){return this._id},getUrl:function(){return this.getDOMWindow().document.URL||""},getTitle:function(){return this.getDOMWindow().document.title||""},getDOMWindow:function(){return this._getBrowser().contentWindow},isActive:function(){return this._tabElem.selected},isPrivate:function(){return this._isWindowPrivate(this.getDOMWindow())},navigate:function(e){this._getBrowser().loadURI(e)},activate:function(){var e=this.getChromeWindow();e.gBrowser.selectedTab=this._tabElem,e.focus()},dispatchMessage:function(e,t){if(this._proxies.length>0){var n={name:e,data:t,origin:"background",source:null,target:null};return array.forEach(this._proxies,function(e){e.proxy.fireEvent("message",n)}),!0}return!1},close:function(){this.getChromeWindow().gBrowser.removeTab(this._tabElem)}};var browser=module.exports=new Browser;module.exports.BrowserTab=BrowserTab,module.exports.getPublicApi=getPublicApi;